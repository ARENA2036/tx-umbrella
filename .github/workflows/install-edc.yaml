# #############################################################################
# Copyright (c) 2023,2024 Contributors to the Eclipse Foundation
#
# See the NOTICE file(s) distributed with this work for additional
# information regarding copyright ownership.
#
# This program and the accompanying materials are made available under the
# terms of the Apache License, Version 2.0 which is available at
# https://www.apache.org/licenses/LICENSE-2.0.
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.
#
# SPDX-License-Identifier: Apache-2.0
# #############################################################################
---
name: Install EDC (Install or Upgrade)

on:
  # push:
    # branches:
    #   - main
    #   - feature/construct-x-infra
  # pull_request:
  #   paths:
  #     - 'charts/**'
  #     - '!**/README.md'
  #     - '.github/workflows/helm-checks.yaml'
  schedule:
    - cron: '0 5 * * 1-5'     # Runs every morning at 05:00 UTC only on Monday to Friday (CEST equivalent to 07:00)
  workflow_dispatch:
    inputs:
      cluster_context:
        default: 'construct-x-fed-services'
        required: false
        description: "Select the environment"
        type: choice
        options:
        - construct-x-fed-services
        - arena2036-x-edc-cluster
        - demo-cluster
      resource_group:
        default: 'rg_construct-x'
        required: false
        description: "Select resource group"
        type: choice
        options:
        - rg_construct-x
        - arena2036-x-edc
        - demo
      deployment_name:
        description: 'helm deployment name e.g, constructx'
        default: 'constructx'
        required: false
        type: string
      deployment_type:
        default: 'upgrade'
        required: false
        description: "Select the command"
        type: choice
        options:
        - install
        - upgrade
      helm_values_file:
        description: 'the relative path to the helm values.yaml'
        default: 'values-construct-x-edcs.yaml'
        required: false
        type: string
      namespace:
        description: 'the namespace where the edc is to be deployed'
        default: 'constructx-edcs'
        required: false
        type: string

jobs:
  install-edc:
    runs-on: ubuntu-latest
    steps:
      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Install kubectl
        run: |
          echo "kubectl is not installed, installing Kubectl..."
          curl -LO -s "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          # Make it executable
          chmod +x kubectl
          # Move to a directory in your PATH
          sudo mv kubectl /usr/local/bin/
          # Verify installation
          kubectl version --client
          echo "kubectl installed successfully!"
          ## kubectl version check
          echo "Checking kubectl version..."
          echo `kubectl version`
      
      - name: Connect Azure-AKS
        run: |
          # Set your azure subscription
          az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          az aks get-credentials --resource-group ${{ github.event.inputs.resource_group }} --name ${{ github.event.inputs.cluster_context }} --overwrite-existing 
      - name: Set up Helm
        uses: azure/setup-helm@b7246b12e77f7134dc2d460a3d5bad15bbe29390 # v4.1.0
        with:
          version: v3.12.1
      
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Deploy EDC
        working-directory: hack/
        run: |
          chmod +x ./install-edc.sh
          echo "Running deployment script..."
          ./install-edc.sh ${{ github.event.inputs.cluster_context }} ${{ github.event.inputs.deployment_name }} ${{ github.event.inputs.deployment_type }} ${{ github.event.inputs.helm_values_file }} ${{ github.event.inputs.namespace }}
